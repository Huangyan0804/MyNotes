# 使Ubuntu-18.04支持休眠

[参考文章1](https://fitzcarraldoblog.wordpress.com/2018/07/14/configuring-lubuntu-18-04-to-enable-hibernation-using-a-swap-file/)

[参考文章2](https://cloud-atlas.readthedocs.io/zh_CN/latest/linux/ubuntu_linux/ubuntu_hibernate.html)

Linux支持 `Suspend` (挂起到内存) 和 `Hibernate` (挂起到磁盘) ，建议使用 `Hibernate` ，这样可以把内存中数据完全存储到磁盘，就可以断开电源，也不会出现因电能不足而关机。

## 检测是否支持休眠

- 检查内核是否支持Hibernate:

```bash
cat /sys/power/state
```

输出中包含 `disk` 就表明支持Hibernate，例如:

```bash
freeze mem disk
```

要验证当前系统是否已经支持Hibernate，只需要执行如下命令:

```bash
sudo systemctl hibernate
```

如果系统能够自动保存所有当前状态，并且在按下电源键自动恢复原先的工作状态则表明已经支持了hibernate。不过，很不幸，默认的系统验证下来是直接关机了。

接下来就是解决方法。

---



## 1. 创建swapfile

根据你的电脑内存大小选择创建多大的swapfile。建议最低为内存大小的2/5。

```bash
sudo swapoff -a
sudo dd if=/dev/zero of=/swapfile bs=1024 count=4M
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapoff -a
sudo swapon /swapfile
```

创建完成后可通过下面任意一行命令检查状态

```bash
swapon -s
free -m
```



## 2.查找UUID

```bash
sudo blkid
```

找到`TYPE="ext4"`这一行的UUID。（忽略PARTUUID）

下面是我的输出:

```bash
/dev/loop0: TYPE="squashfs"
/dev/loop1: TYPE="squashfs"
/dev/loop2: TYPE="squashfs"
/dev/loop3: TYPE="squashfs"
/dev/loop4: TYPE="squashfs"
/dev/loop5: TYPE="squashfs"
/dev/loop6: TYPE="squashfs"
/dev/loop7: TYPE="squashfs"
/dev/nvme0n1: PTUUID="0a083bfe-e914-4890-8421-d583b58f5916" PTTYPE="gpt"
/dev/nvme0n1p1: UUID="1249-1039" TYPE="vfat" PARTLABEL="EFI System Partition" PARTUUID="a3a34475-eafd-410b-8fed-975b25685709"
/dev/nvme0n1p2: UUID="f406e523-b0bb-45e0-a159-96b32c70da0f" TYPE="ext4" PARTUUID="96f00fcb-af84-4865-920a-5ee25d564f01"
/dev/loop8: TYPE="squashfs"
/dev/loop9: TYPE="squashfs"
/dev/loop10: TYPE="squashfs"
/dev/loop11: TYPE="squashfs"
/dev/loop12: TYPE="squashfs"
/dev/loop13: TYPE="squashfs"
/dev/loop14: TYPE="squashfs"
/dev/loop15: TYPE="squashfs"
/dev/loop16: TYPE="squashfs"

# 我的是 /dev/nvme0n1p2: UUID="f406e523-b0bb-45e0-a159-96b32c70da0f" TYPE="ext4" PARTUUID="96f00fcb-af84-4865-920a-5ee25d564f01"

```

## 3.查找resume偏移量



```bash
sudo filefrag -v /swapfile
```

偏移量通常在第一行的`physical_offset`下面的第一个值

下面是我的输出:

```bash
Filesystem type is: ef53
File size of /swapfile is 4294967296 (1048576 blocks of 4096 bytes)
 ext:     logical_offset:        physical_offset: length:   expected: flags:
   0:        0..       0:   27165763..  27165763:      1:            
   1:        1..   20479:   24489984..  24510462:  20479:   27165764:
   2:    20480..   53247:   24510464..  24543231:  32768:   24510463:
   3:    53248..   86015:   24543232..  24575999:  32768:            
   4:    86016..  118783:   24576000..  24608767:  32768:            
   5:   118784..  151551:   24608768..  24641535:  32768:            
   6:   151552..  159743:   24993792..  25001983:   8192:   24641536:
   7:   159744..  165887:   25004032..  25010175:   6144:   25001984:
   8:   165888..  167935:   25022464..  25024511:   2048:   25010176:
   9:   167936..  172031:   25018368..  25022463:   4096:   25024512:
  10:   172032..  176127:   25026560..  25030655:   4096:   25022464:
  11:   176128..  180223:   25040896..  25044991:   4096:   25030656:
  12:   180224..  184319:   25399296..  25403391:   4096:   25044992:
  13:   184320..  192511:   25520128..  25528319:   8192:   25403392:
  14:   192512..  194559:   25530368..  25532415:   2048:   25528320:
  15:   194560..  196607:   25548800..  25550847:   2048:   25532416:
  16:   196608..  198655:   25585664..  25587711:   2048:   25550848:
  17:   198656..  200703:   25618432..  25620479:   2048:   25587712:
  18:   200704..  202751:   25647104..  25649151:   2048:   25620480:
  19:   202752..  206847:   25675776..  25679871:   4096:   25649152:
  20:   206848..  208895:   25686016..  25688063:   2048:   25679872:
  21:   208896..  210943:   25806848..  25808895:   2048:   25688064:
  22:   210944..  212991:   25927680..  25929727:   2048:   25808896:
  23:   212992..  215039:   26372096..  26374143:   2048:   25929728:
  24:   215040..  217087:   26386432..  26388479:   2048:   26374144:
  25:   217088..  219135:   26499072..  26501119:   2048:   26388480:
  26:   219136..  221183:   26568704..  26570751:   2048:   26501120:
  27:   221184..  223231:   26613760..  26615807:   2048:   26570752:
  28:   223232..  225279:   26693632..  26695679:   2048:   26615808:
  29:   225280..  227327:   26853376..  26855423:   2048:   26695680:
  30:   227328..  233471:   26912768..  26918911:   6144:   26855424:
  31:   233472..  235519:   26953728..  26955775:   2048:   26918912:
  32:   235520..  237567:   26959872..  26961919:   2048:   26955776:
  33:   237568..  241663:   26947584..  26951679:   4096:   26961920:
  34:   241664..  249855:   26935296..  26943487:   8192:   26951680:
  35:   249856..  251903:   27013120..  27015167:   2048:   26943488:
  36:   251904..  253951:   27021312..  27023359:   2048:   27015168:
  37:   253952..  255999:   27039744..  27041791:   2048:   27023360:
  38:   256000..  258047:   27062272..  27064319:   2048:   27041792:
  39:   258048..  262143:   27158528..  27162623:   4096:   27064320:
  40:   262144..  270335:   27148288..  27156479:   8192:   27162624:
  41:   270336..  272383:   27168768..  27170815:   2048:   27156480:
  42:   272384..  274431:   27172864..  27174911:   2048:   27170816:
  43:   274432..  276479:   27201536..  27203583:   2048:   27174912:
  44:   276480..  296959:   27211776..  27232255:  20480:   27203584:
  45:   296960..  305151:   27234304..  27242495:   8192:   27232256:
  46:   305152..  321535:   27246592..  27262975:  16384:   27242496:
  47:   321536..  323583:   27398144..  27400191:   2048:   27262976:
  48:   323584..  325631:   27408384..  27410431:   2048:   27400192:
  49:   325632..  327679:   27463680..  27465727:   2048:   27410432:
  50:   327680..  331775:   27475968..  27480063:   4096:   27465728:
  51:   331776..  333823:   27510784..  27512831:   2048:   27480064:
  52:   333824..  339967:   27514880..  27521023:   6144:   27512832:
  53:   339968..  348159:   27523072..  27531263:   8192:   27521024:
  54:   348160..  350207:   27539456..  27541503:   2048:   27531264:
  55:   350208..  364543:   27543552..  27557887:  14336:   27541504:
  56:   364544..  372735:   27561984..  27570175:   8192:   27557888:
  57:   372736..  387071:   27578368..  27592703:  14336:   27570176:
  58:   387072..  391167:   27650048..  27654143:   4096:   27592704:
  59:   391168..  395263:   27631616..  27635711:   4096:   27654144:
  60:   395264..  399359:   27643904..  27647999:   4096:   27635712:
  61:   399360..  405503:   27666432..  27672575:   6144:   27648000:
  62:   405504..  409599:   27656192..  27660287:   4096:   27672576:
  63:   409600..  417791:   27680768..  27688959:   8192:   27660288:
  64:   417792..  428031:   27691008..  27701247:  10240:   27688960:
  65:   428032..  430079:   27740160..  27742207:   2048:   27701248:
  66:   430080..  432127:   27744256..  27746303:   2048:   27742208:
  67:   432128..  440319:   27764736..  27772927:   8192:   27746304:
  68:   440320..  446463:   27777024..  27783167:   6144:   27772928:
  69:   446464..  448511:   27877376..  27879423:   2048:   27783168:
  70:   448512..  452607:   27873280..  27877375:   4096:   27879424:
  71:   452608..  454655:   27889664..  27891711:   2048:   27877376:
  72:   454656..  462847:   27910144..  27918335:   8192:   27891712:
  73:   462848..  468991:   27928576..  27934719:   6144:   27918336:
  74:   468992..  473087:   27922432..  27926527:   4096:   27934720:
  75:   473088..  499711:   27938816..  27965439:  26624:   27926528:
  76:   499712..  501759:   27979776..  27981823:   2048:   27965440:
  77:   501760..  509951:   27971584..  27979775:   8192:   27981824:
  78:   509952..  528383:   28067840..  28086271:  18432:   27979776:
  79:   528384..  561151:   28090368..  28123135:  32768:   28086272:
  80:   561152..  593919:   28125184..  28157951:  32768:   28123136:
  81:   593920..  618495:   28157952..  28182527:  24576:            
  82:   618496..  620543:   28188672..  28190719:   2048:   28182528:
  83:   620544..  622591:   28192768..  28194815:   2048:   28190720:
  84:   622592..  655359:   28211200..  28243967:  32768:   28194816:
  85:   655360..  659455:   28243968..  28248063:   4096:            
  86:   659456..  692223:   28250112..  28282879:  32768:   28248064:
  87:   692224..  702463:   28282880..  28293119:  10240:            
  88:   702464..  718847:   28295168..  28311551:  16384:   28293120:
  89:   718848..  720895:   28358656..  28360703:   2048:   28311552:
  90:   720896..  733183:   28381184..  28393471:  12288:   28360704:
  91:   733184..  735231:   28483584..  28485631:   2048:   28393472:
  92:   735232..  739327:   28487680..  28491775:   4096:   28485632:
  93:   739328..  747519:   28522496..  28530687:   8192:   28491776:
  94:   747520..  755711:   28592128..  28600319:   8192:   28530688:
  95:   755712..  763903:   28614656..  28622847:   8192:   28600320:
  96:   763904..  774143:   28631040..  28641279:  10240:   28622848:
  97:   774144..  776191:   28909568..  28911615:   2048:   28641280:
  98:   776192..  790527:   28919808..  28934143:  14336:   28911616:
  99:   790528..  823295:   28936192..  28968959:  32768:   28934144:
 100:   823296..  856063:   28968960..  29001727:  32768:            
 101:   856064..  888831:   29001728..  29034495:  32768:            
 102:   888832..  921599:   29034496..  29067263:  32768:            
 103:   921600..  954367:   29067264..  29100031:  32768:            
 104:   954368..  966655:   29100032..  29112319:  12288:            
 105:   966656..  999423:   29114368..  29147135:  32768:   29112320:
 106:   999424.. 1032191:   29147136..  29179903:  32768:            
 107:  1032192.. 1048575:   29179904..  29196287:  16384:             last,eof
/swapfile: 95 extents found

# 我的是 27165763
```



你也可以安装`uswsusp`来查看这个偏移量

```bash
sudo apt install uswsusp
sudo swap-offset /swapfile
```



## 4.更新/boot/grub/grub.cfg文件

```bash
sudo vim /etc/default/grub
```

用步骤2，3的参数修改下面的命令然后加到 `GRUB_CMDLINE_LINUX_DEFAULT` 这一行的最后。

```bash
resume=UUID=f406e523-b0bb-45e0-a159-96b32c70da0f resume_offset=27165763 resumedelay=5
```



示例：

```bash
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash resume=UUID=f406e523-b0bb-45e0-a159-96b32c70da0f resume_offset=27165763 resumedelay=5"
```

**注意**：`resumedelay=15` 参数是指定在尝试读取恢复文件之前暂停的延迟（以秒为单位）。我添加这个是为了让包含交换文件的文件系统有足够的时间成为读写文件。

完成后刷新文件

```bash
sudo update-grub
```



## 5.创建/etc/initramfs-tools/conf.d/resume文件

```bash
sudo vim /etc/initramfs-tools/conf.d/resume
```

继续用2，3得到的参数添加进去

```bash
resume=UUID=f406e523-b0bb-45e0-a159-96b32c70da0f resume_offset=27165763
```

刷新文件

```bash
sudo update-initramfs -u -k all
```



## 6.更新系统文件，允许睡眠



首先查看polkit版本

```bash
 pkaction --version
```



#### 如果版本<0.106

新建文件

```bash
sudo vim /var/lib/polkit-1/localauthority/50-local.d/50-enable-suspend-on-lockscreen.pkla
```

添加以下

```bash
[Allow hibernation and suspending with lock screen]
Identity=unix-user:*
Action=org.freedesktop.login1.suspend;org.freedesktop.login1.suspend-multiple-sessions;org.freedesktop.login1.hibernate;org.freedesktop.login1.hibernate-multiple-sessions
ResultAny=yes
ResultInactive=yes
ResultActive=yes
```



#### 版本>= 0.106

新建文件

```bash
sudo vim /etc/polkit-1/rules.d/85-suspend.rules
```

添加以下

```shell
polkit.addRule(function(action, subject) {
    if (action.id == "org.freedesktop.login1.suspend" ||
        action.id == "org.freedesktop.login1.suspend-multiple-sessions" ||
        action.id == "org.freedesktop.login1.hibernate" ||
        action.id == "org.freedesktop.login1.hibernate-multiple-sessions")
    {
        return polkit.Result.YES;
    }
});
```

## 7. 重启

```bash
reboot
```

